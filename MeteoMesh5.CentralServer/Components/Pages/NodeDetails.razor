@page "/node/{NodeId}"
@using MeteoMesh5.CentralServer.Models
@using MeteoMesh5.CentralServer.Services
@inject LocalNodeManager nodeManager
@inject LocalNodeDataService dataService
@inject NavigationManager Nav
@inject TimeProvider timeProvider

<PageTitle>Node Details - @NodeId</PageTitle>

<section class="hero container my-4 p-4 p-lg-5">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="display-6 fw-bold mb-2">
                <i class="bi bi-hdd-network me-2"></i>
                Node Details
            </h1>
        </div>
        <div class="d-flex gap-3">
            <div class="d-flex gap-3">
                <button class="btn btn-outline-sky" @onclick="Refresh">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                </button>
            </div>
        </div>
    </div>
</section>

@if (node == null)
{
    <section class="container">
        <div class="tile text-center py-5">
            <i class="bi bi-exclamation-triangle fs-1 d-block mb-2"></i>
            <h4>Node Not Found</h4>
            <p class="text-muted">The node "@NodeId" is not currently registered with this central server.</p>
            <p class="text-muted small">The node may be offline, or the Node ID may be incorrect.</p>
            <button class="btn btn-sky mt-2" @onclick="GoHome">
                <i class="bi bi-house me-1"></i>Back to Home
            </button>
        </div>
    </section>
}
else
{
    <!-- Node Overview Section -->
    <section class="container mb-4">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="tile h-100">
                    <h5 class="mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Node Information
                    </h5>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="kpi">
                                <div class="label">Node ID</div>
                                <div class="value"><code>@node.NodeId</code></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi">
                                <div class="label">Name</div>
                                <div class="value">@node.Name</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi">
                                <div class="label">Status</div>
                                <div class="value @(node.IsOnline ? "text-success" : "text-danger")">
                                    <i class="bi @(node.IsOnline ? "bi-check-circle" : "bi-x-circle") me-1"></i>
                                    @(node.IsOnline ? "Online" : "Offline")
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi">
                                <div class="label">Last Seen</div>
                                <div class="value">@node.LastSeen.ToString("HH:mm:ss")</div>
                                <div class="muted">@GetTimeSinceLastSeen()</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi">
                                <div class="label">Location</div>
                                <div class="value">@(string.IsNullOrEmpty(node.Location) ? "Unknown" : node.Location)</div>
                                @if (node.Latitude.HasValue && node.Longitude.HasValue)
                                {
                                    <div class="muted small">@node.Latitude.Value.ToString("F4"), @node.Longitude.Value.ToString("F4")</div>
                                }
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi">
                                <div class="label">Node URL</div>
                                <div class="value">
                                    @if (!string.IsNullOrEmpty(node.NodeUrl))
                                    {
                                        <code class="small">@node.NodeUrl</code>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Not provided</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="tile h-100">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up me-2"></i>
                        Station Summary
                    </h5>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="kpi text-center">
                                <div class="label">Total Stations</div>
                                <div class="value text-primary">@node.Stations.Count</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi text-center">
                                <div class="label">Active Stations</div>
                                <div class="value text-success">@GetActiveStationCount(node)</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi text-center">
                                <div class="label">Suspended</div>
                                <div class="value text-warning">@GetSuspendedStationCount(node)</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi text-center">
                                <div class="label">Temperature</div>
                                <div class="value text-danger">@GetStationCountByType(StationType.Temperature)</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi text-center">
                                <div class="label">Humidity</div>
                                <div class="value text-info">@GetStationCountByType(StationType.Humidity)</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi text-center">
                                <div class="label">Pressure</div>
                                <div class="value text-primary">@GetStationCountByType(StationType.Pressure)</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="kpi text-center">
                                <div class="label">Lidar</div>
                                <div class="value text-success">@GetStationCountByType(StationType.Lidar)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stations Detail Section -->
    <section class="container">
        <div class="tile p-0">
            <div class="d-flex justify-content-between align-items-center mb-0 p-3 pb-0">
                <h3 class="h5 mb-0">
                    <i class="bi bi-broadcast-pin me-2"></i>
                    Stations (@node.Stations.Count)
                </h3>
              @*   @if (node.IsOnline && !string.IsNullOrEmpty(node.NodeUrl))
                {
                    <button class="btn btn-outline-sky btn-sm" @onclick="LoadDetailedData">
                        <i class="bi bi-download me-1"></i>Load Recent Data
                    </button>
                } *@
            </div>
            @if (node.Stations.Any())
            {
                <div class="table-responsive">
                    <table class="table align-middle m-0">
                        <thead class="table-light">
                            <tr>
                                <th>Station ID</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Last Update</th>
                                <th>Last Value</th>
                                <th>Quality</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var station in node.Stations.OrderBy(s => s.StationId))
                            {
                                <tr class="@(station.IsActive ? string.Empty : "table-secondary")">
                                    <td>
                                        <i class="bi bi-broadcast-pin me-1"></i>
                                        <code>@station.StationId</code>
                                    </td>
                                    <td>
                                        <span class="badge @GetTypeBadgeClass(station.Type)">@station.Type</span>
                                    </td>
                                    <td>
                                        @if (station.Suspended)
                                        {
                                            <span class="text-warning">
                                                <i class="bi bi-pause-circle me-1"></i>Suspended
                                            </span>
                                        }
                                        else if (station.IsActive)
                                        {
                                            <span class="text-success">
                                                <i class="bi bi-check-circle me-1"></i>Active
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-danger">
                                                <i class="bi bi-x-circle me-1"></i>Inactive
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @if (station.LastUpdate != default)
                                        {
                                            @station.LastUpdate.ToString("yyyy-MM-dd HH:mm:ss")
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td>
                                        @if (station.LastValue.HasValue)
                                        {
                                            @FormatValue(station.LastValue.Value, station.Type)
                                        }
                                        else
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="@(station.Quality == "Good" ? "text-success" : "text-warning")">@station.Quality</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-broadcast-pin fs-1 d-block mb-2"></i>
                    <h5 class="mt-3">No Stations</h5>
                    <p class="text-muted">This node has not registered any stations yet.</p>
                </div>
            }
        </div>
    </section>
}

@code {
    [Parameter] public string NodeId { get; set; } = string.Empty;

    private LocalNodeInfo? node;
    private DateTime lastUpdate;

    protected override void OnParametersSet()
    {
        LoadNode();
    }

    private void LoadNode()
    {
        node = nodeManager.GetNode(NodeId);
        lastUpdate = timeProvider.GetUtcNow().UtcDateTime;
    }

    private void Refresh()
    {
        LoadNode();
        StateHasChanged();
    }

    private void GoHome() => Nav.NavigateTo("/");

    private async Task LoadDetailedData()
    {
        if (node == null || string.IsNullOrEmpty(node.NodeUrl)) return;

        try
        {
            // Fetch recent data from this specific node
            var measurements = await dataService.FetchDataFromNodeAsync(NodeId, null, null, null, 10);
            // Could display this data or show a success message
            lastUpdate = timeProvider.GetUtcNow().UtcDateTime;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Handle error silently or show notification
        }
    }

    private string GetTimeSinceLastSeen()
    {
        if (node == null) return "";

        var currentTime = timeProvider.GetUtcNow().UtcDateTime;
        var timeSince = currentTime - node.LastSeen;

        if (timeSince.TotalMinutes < 1)
            return "just now";
        if (timeSince.TotalMinutes < 60)
            return $"{timeSince.Minutes} minutes ago";
        if (timeSince.TotalHours < 24)
            return $"{timeSince.Hours} hours ago";
        return $"{timeSince.Days} days ago";
    }

    private int GetStationCountByType(StationType type)
    {
        return node?.Stations.Count(s => s.Type == type) ?? 0;
    }

    private int GetActiveStationCount(LocalNodeInfo node)
    {
        return node.Stations.Count(s => s.IsActive && !s.Suspended);
    }

    private int GetSuspendedStationCount(LocalNodeInfo node)
    {
        return node.Stations.Count(s => s.Suspended);
    }

    private string GetTypeBadgeClass(StationType type)
    {
        return type switch
        {
            StationType.Temperature => "bg-danger text-white",
            StationType.Humidity => "bg-info text-white",
            StationType.Pressure => "bg-primary text-white",
            StationType.Lidar => "bg-success text-white",
            _ => "bg-secondary text-white"
        };
    }

    private string FormatValue(double value, StationType type)
    {
        return type switch
        {
            StationType.Temperature => $"{value:F1}°C",
            StationType.Humidity => value == -999 ? "Suspended" : $"{value:F1}%",
            StationType.Pressure => $"{value:F1} hPa",
            StationType.Lidar => value > 0 ? $"{value:F2} mm/h" : "No rain",
            _ => value.ToString("F2")
        };
    }
}